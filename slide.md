### 7年間運用したソーシャルゲームを<br>Amazon EC2構成からAmazon ECS構成へと<br>乗り換えた話

---

### 自己紹介

<img src="./img/marunouchi_ol_trans.png" width="10%"><br>

- 大澤 純 (@commojun)
- 2016~ サーバサイドエンジニア@KAYAC

---

アホみたいなことをつぶやいたり

<img src="./img/perlnigeruna.png" class="r-stretch">

---

バカゲーを作ってリリースしちゃったりしています

<img src="./img/kusonazo.png" class="r-stretch">

---

### 目次

- ぼくらの甲子園!ポケットについて
- EC2時代のサーバ構成
- なぜECSに乗り換えるか
- ホコリかぶったPerlとモジュールのバージョンアップ
- 巨大プロジェクトのDockerイメージを焼く
- 時代に乗ったデプロイ方法にする
- ゲームの心臓なのにSPOFになっていたバッチサーバの冗長化作戦
- 非エンジニアに仕事をわかってもらう

---

## ぼくらの甲子園!ポケットについて

---

ぼくらの甲子園!ポケットは2014年から運用を続けているソーシャルゲームタイトルです。

おかげさまで2021年10月で8周年を迎えることができました。

公式サイトの画像

---

### ぼくらの甲子園!ポケットの特徴

- ユーザは監督ではなく、選手である
- ユーザが9人集まらないと試合すらできない
- チームメイトの一人ひとりがユーザ
- ユーザは選手になって甲子園を目指すため、青春を追体験できる

監督 -> キャラクタ

プレイヤー　プレイヤー　みたいな絵

---

### ぼくらの甲子園!ポケットの特徴

- 2週間に1回の甲子園大会に出場するためにリーグ戦を繰り返す
- 甲子園大会はトーナメント戦で1日かけて行う
- 優勝すると、優勝チームの要望に応えた新聞を運営が作成し、ゲーム内に掲載する

試合中の絵と新聞の絵

---

### ぼくらの甲子園!ポケットの特徴

- リーグ戦の試合は毎日定刻に開始
- 参加するには決まった時間にログインしなければならない
- 作戦会議中にスキルを発動したり、仲間にエールを送ったりする
- 作戦会議が終了すると完全オートで試合が進行する
- 複雑なアクションは無く、戦況に応じてどのスキルを使うかが重要
- 打席・試合の結果は全てサーバのバッチ実行によって決定する

---

## EC2時代のサーバ構成

---

ぼくらの甲子園!ポケットは2014年9月12日リリース

当然開発はそれよりも前に開始していた。その頃の時流に乗ったサーバ構成

---

perl 5.16 on Amazon EC2 な図がどっかにないかな？

<div class="r-stack">
    <span class="fragment current-visible">役割に応じたEC2インスタンスがあり、必要に応じてオートスケールをしたりする</span>
    <span class="fragment current-visible">Aurora MySQLや、Elasticache（Redis）などマネジメントされた物を利用</span>
    <span class="fragment">batchサーバ上でcrondが常駐して、定刻の試合開始を行っている</span>
</div>

---

## なぜECSに乗り換えるか

---

### 1, Amazon Linuxのサポート終了

EC2上で利用しているOSのサポートが2020年末に終了するため、何かしら手を打たなければならなかった

後継OS Amazon Linux2 への乗り換えという選択肢もあるが…

---

### 2, コンテナを利用したサーバ構築が当たり前になりつつある

他のゲームタイトルなどで、Amazon ECS構成を使ったゲームサーバについて社内に知見が貯まっていた

---

### 3, このゲームの運用を10年続けたい！

長期運用タイトルにする意思が総意としてあった

リリース時から時代が変わっているので、将来性のある構成に乗り換えよう！

---

## ホコリかぶったPerlとモジュールのバージョンアップ

---

インフラ構成もだが、言語のバージョンとモジュールのバージョンも長らくメンテされていなかった

---

「図」

運用が続くとゲーム体験に関係のある部分にしか関心が向かなくなりがち

---

### Perl 5.16 👉 Perl 5.30

---

エイヤで言語バージョンを上げてみる

---

@INC問題

---

コンパイルエラーしまくる

---

テストが運で落ちたり通ったりする

管理画面の表示順シャッフルも

---

### モジュールのバージョンを上げてみる

---

### 蓋を開けてみると見えた問題

- そもそも cpanfile.snapshot でのバージョン管理がなされていなかった
- 後方互換の無いモジュールバージョンアップがうっかり混入してあわてて固定する運用
- モンキーパッチを当てたせいでバージョンを上げられない
- 日本語を含んだJSONのリクエストがどうしても上手くさばけない

---

ネストされたJSONリクエストの中に日本語が含まれていた場合、正しくエンコードされない問題

---

ネストされたJSONリクエストが正しくデコードされない問題

---

